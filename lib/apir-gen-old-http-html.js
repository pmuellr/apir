// Generated by CoffeeScript 1.6.3
var HTMLTemplate, Mustache, PROGRAM, augment, augmentType, augmentTypes, collectTypes, fs, markUsed, path, removeFunctions, removeUnusedObjects, _;

fs = require("fs");

path = require("path");

_ = require("underscore");

Mustache = require('mustache');

PROGRAM = path.basename(__filename);

PROGRAM = (PROGRAM.match(/(.*)\..*/))[1];

exports.process = function(api, options) {
  var fname, html, logger, output;
  output = options.output, logger = options.logger;
  logger = logger.newLogger(PROGRAM);
  fname = "" + output + "-http.html";
  html = Mustache.render(HTMLTemplate, augment(api));
  logger.log("generating " + fname);
  return fs.writeFileSync(fname, html);
};

HTMLTemplate = "<style>\n\n    body {\n        font-size:          150%;\n    }\n\n    table {\n        font-size:          100%;\n    }\n\n    td {\n        padding-right:      0.5em;\n        vertical-align:     top;\n    }\n\n    h3, h4 { \n        margin-bottom:      0em; \n    }\n\n    .typeName {\n        font-style:         italic;\n    }\n\n    h3 {\n        background-color:   #eee;\n        padding:            0.5em 1em;\n        margin-top:         0em;\n        margin-left:        0em;\n        border-radius:      10px;\n    }\n\n    .indent { \n        margin-left:        3em;\n    }\n\n    .bordered {\n        border:             thin solid black;\n        border-radius:      10px;\n        padding:            0em 0em 0em 0em;\n        margin-bottom:      1em;\n    }\n\n</style>\n\n<title>{{title}}</title>\n\n<h1>{{title}}</h1>\n<p>{{desc}}\n\n<!-- =================================== -->\n<h2>HTTP requests</h2>\n<div class=indent>\n\n    {{#https}}\n    <div class=bordered>\n    <h3><tt>{{method}} {{uri}}</tt></h3>\n\n        <div class=indent>\n            <p>{{desc}}\n\n            <h4>parms:</h4>\n            <div class=indent>\n                <table>\n\n                {{#parms}}\n                    <tr>\n                        <td><b>{{name}}: </b>\n                        <td>{{{typeLink}}}\n                        {{#desc}}<td> - {{/desc}}\n                        {{^desc}}<td>   {{/desc}}\n                        <td>{{.}}\n                {{/parms}}\n\n                {{^parms}}\n                    <tr><td>none\n                {{/parms}}\n\n                </table>\n            </div>\n\n            <h4>response:</h4>\n            <div class=indent>\n                <table>\n\n                {{#response}}\n                    <tr>\n                        <td>{{{typeLink}}}\n                        {{#desc}}<td> - {{/desc}}\n                        {{^desc}}<td>   {{/desc}}\n                        <td>{{desc}}\n                {{/response}}\n\n                {{^response}}\n                    <tr><td>none\n                {{/response}}\n\n                </table>\n            </div>\n\n        </div>\n    </div>\n    {{/https}}\n\n</div>\n\n<!-- =================================== -->\n<h2>objects</h2>\n<div class=indent>\n\n    {{#objects}}\n    <div class=bordered>\n        <h3 id={{name}}><tt>{{name}}</tt></h3>\n\n        <div class=indent>\n            <p>{{desc}}\n\n            <h4>properties:</h4>\n            <div class=indent>\n                <table>\n                {{#props}}\n                    <tr>\n                        <td><b>{{name}}: </b>\n                        <td>{{{typeLink}}}\n                        {{#desc}}<td> - {{/desc}}\n                        {{^desc}}<td>   {{/desc}}\n                        <td>{{desc}}\n                {{/props}}\n\n                {{^props}}\n                    <tr><td>none\n                {{/props}}\n                </table>\n            </div>\n\n        </div>\n    </div>\n\n    {{/objects}}\n\n</div>";

augment = function(api) {
  var types;
  types = collectTypes(api);
  removeFunctions(api);
  removeUnusedObjects(api, types);
  augmentTypes(api);
  return api;
};

collectTypes = function(api) {
  var object, types, _i, _len, _ref;
  types = {};
  _ref = api.objects;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    object = _ref[_i];
    types[object.name] = object;
  }
  return types;
};

removeFunctions = function(api) {
  var object, _i, _len, _ref, _results;
  _ref = api.objects;
  _results = [];
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    object = _ref[_i];
    _results.push(object.props = _.filter(object.props, function(prop) {
      return !prop.isFunction;
    }));
  }
  return _results;
};

removeUnusedObjects = function(api, types) {
  var http, parm, _i, _j, _len, _len1, _ref, _ref1;
  _ref = api.https;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    http = _ref[_i];
    markUsed(types, http.response.type);
    _ref1 = http.parms;
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      parm = _ref1[_j];
      markUsed(types, parm.type);
    }
  }
  return api.objects = _.filter(api.objects, function(object) {
    return object.isUsed;
  });
};

markUsed = function(types, typeName) {
  var prop, type, _i, _len, _ref;
  type = types[typeName];
  if (type == null) {
    return;
  }
  if (type.isUsed) {
    return;
  }
  type.isUsed = true;
  _ref = type.props;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    prop = _ref[_i];
    markUsed(types, prop.type);
  }
};

augmentTypes = function(api) {
  var http, object, parm, prop, _i, _j, _k, _l, _len, _len1, _len2, _len3, _ref, _ref1, _ref2, _ref3, _results;
  _ref = api.objects;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    object = _ref[_i];
    _ref1 = object.props;
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      prop = _ref1[_j];
      augmentType(prop);
    }
  }
  _ref2 = api.https;
  _results = [];
  for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
    http = _ref2[_k];
    _ref3 = http.parms;
    for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
      parm = _ref3[_l];
      augmentType(parm);
    }
    _results.push(augmentType(http.response));
  }
  return _results;
};

augmentType = function(type) {
  type.typeString = type.type;
  if (type.arity) {
    type.typeString = "" + type.typeString + "[]";
  }
  if (type.isPrim) {
    type.typeLink = "<span class=typeName>" + type.typeString + "</span>";
  } else {
    type.typeLink = "<a class=typeName href='#" + type.type + "'>" + type.typeString + "</a>";
  }
};
